<!DOCTYPE html>
<html>
    <!-- http://www.commentcamarche.net/forum/affich-26511139-recuperation-de-valeur-d-un-input-html-en-javascript-->
    <!--https://www.europeandataportal.eu/data/en/dataset?country=fr&organization=plateforme-ouverte-des-donnees-publiques-francaises&res_format=GeoJSON-->
    <!--http://stackoverflow.com/questions/6458840/on-input-change-event-->
    <head>
        <meta charset = "UTF-8"/>
        <title>Geodiff</title>
         <script type="text/javascript" src="jquery-3.1.1.min.js"></script><!-- utilise l -->
         <!--<script type="text/javascript" src="CompareGeojsonGeometry.js"></script> -->
         <!--cette version ne tient pas compte de l'ordre dans les type multi ni dans les coutour interieur des polygone -->

          <script type="text/javascript" src="CompareGeojsonGeometryOrdonne.js"></script> 
          <!--cette version tient compte de l'ordre dans tout les type -->
          <!--cette version ne prend pas en compte les cycles : [p1,p2,p3] diferent de [p2,p3,p1] --> 
    </head> 

    <body>
        <!--Ce formulaire permet a l'utilisateur de donner son champs id contenue dans les properties -->

        <!--C'est le seul cas traite pour le moment  -->
        <!-- Le bouton ok deviens cliquable apres avoir remplit le champs texte -->
        <!--amelioraion possible traiter le cas d'un champ id ailleurs que dans les properties  -->
         <FORM>
            <p>Indiquer le nom de votre champs id svp<p>
            <input type="text" name="id_name_field" id="id_name_field" value=""  />
            <input type="button" id="buttonOK" value="OK" onclick="getID();" disabled="disabled"/>
        
        </FORM> 
        <!-- Ici on pemet a l'utilisateur de chosir les fichiers d'entree puis de telecharger le resultat -->
        <!--Il n'est pas visible avant la validation du nom du champs id au precedent formulaire-->
            <input id="file" type="file" multiple style="visibility: hidden;" />
            <input id="download" type="button" value="telecharger"  onclick="download();"style="visibility: hidden;" />
        <!--Ce formulaire cache sert a envoyer les resultat au code php par un POST-->
       <FORM method="POST" action="Transfert.php" id="dataform" hidden>
            <input type="text" name="data" id="datainput" hidden>

      </FORM> 


<script>
    //variables globale ! 
    //amelioration possible : refactoring de certain nom,separer les implementaions ... 
    var id_table= new Array();//verification unicite des id 
    id_table[0] = new Array();
    id_table[1] = new Array(); 
    var myObject = new Array();
    myObject[3]=new Array();//contiendra les modifications
    myObject[4]=new Array();//contiendra les ajouts
    //myObject[0] contiendra les supressions  
    //myObject[1] contiendra fichier 1
    //myObject[2] contiendra fichier 2
    var i = 1 ;
    var fileInput = document.querySelector('#file'); //recuperation des fichier d'entree
    var sup; //debug voir l'element supprime de myobject[1]
    var v = 0 ;
    //garde le nb de supression DEBUG 
    var reader = new FileReader();
    var fich_supp="",fich_modif="",fich_ajout="",fich_total="";//contiendra les chaines geojson correspondant au different type (ajout,modification,suppression) 
    //et le fichier complet
    var geodiff_type="geodiff_type" //nom de la propriete a ajouter pour separer selon les modification .Valeur possible de cette propriete add,del,mod

    /*
        recupere le nom de la propriete contenant un identifiant et demasque le choix des fichier d'entree 
    */
    function getID()
    {
        //12:27:05,131 L’utilisation de « getPreventDefault() » est obsolète. Utiliser « defaultPrevented » à la place. 
        id_name = document.getElementById("id_name_field").value;
        document.getElementById("file").style.visibility="visible"; //demasquage pour choisir fichier 
        console.log("id:",id_name);
        //return id_name;
    } 
     /*
        le bouton ok devient cliquable lorsque l'utilisateur rentre un nom d'id
    */
    var input = document.getElementById("id_name_field");
    input.oninput=function()
    {
            //console.log('input changed to: ', input.value);
            document.getElementById('buttonOK').disabled = this.value ? false : true;
    };

    /*

    envoi les resultats geojson (ajout,modif,supp et total) vers Transfer.php (a l'aide d'un formulaire caché) pour creer une archive et permettre son telechargement  

    */
     function download(){ 
       
            var data =fich_modif +"\n"+ fich_ajout+"\n" +fich_supp+"\n" +fich_total ;//envoyer les 3 "fichier" avec retour a la ligne 
            //console.log(data);
            var form = document.getElementById('dataform');
            var input = document.getElementById('datainput');
            //input.value=urlencode(data);
            input.value=encodeURIComponent(data);
            form.submit();
    }
    

    //evenement fin du chargement du fichier 
    reader.addEventListener('loadend', function(){ 
        //console.log("id:",id_name);
        myObject[i] = (JSON.parse(reader.result));//parseur json
        var numero_de_ligne = 0;
        //console.log("debut",myObject);
        //verification des id 
        for (var k = 0 ; k < myObject[i].features.length ; k = k + 1 ){//pour chaque id
                if (id_table[i-1][myObject[1].features[k].properties[id_name]] !== undefined){//si l'id existe deja 
                    console.log("erreur id non unique");
                    return -1;
                }
                else{
                    id_table[i-1][myObject[i].features[k].properties[id_name]] = k;//ajout de l'id et de son indice dans la table
                    //console.log("id_table",i,myObject[i].features[k].properties[id_name],id_table[i-1][myObject[i].features[k].properties[id_name]]);
                }                    

        }
        if (i === 1){//on copie le premier fichier dans myobjet[0] il est deja present dans myobject[1]
            //myObject[0] contiendra les suppression on l'initalise avec tout le contenu du 1 er fichier 
            //et on le reduira petit a petit dans la suite
            myObject[0] = jQuery.extend(true,{},myObject[1]);//prends de la place memoire 
            //ajout marqueur de deletion  dans les propriete 
            for (var l = 0 ; l < myObject[0].features.length ; l = l + 1 ){
                    myObject[0].features[l].properties[geodiff_type]="del";
            }
            i = i + 1;
        }
        else{
            for (var j = 0 ; j < myObject[i].features.length ; j = j + 1 ){ //parcours du i eme fichier i = 2 
                if (myObject[i].features[j].properties[id_name] in id_table[0]){//si l'id du feature j du deuxieme fichier existe dans le premier
                    //on recupere l'index correspondant dans le premier fichier 
                    numero_de_ligne = id_table[0][myObject[i].features[j].properties[id_name]];
                    //console.log(" j ",j,"numero de ligne",numero_de_ligne);
                    //DEBUG
                    //console.log("tableau avant sup = ",myObject[0].features);
                    //console.log("k-v:",k-v);
                    //console.log("v",v);
                    //FIN DEBUG
                    sup = myObject[0].features.splice(numero_de_ligne-v,1);//ce n'est pas une suppression donc on l'enleve du fichier qui contiendra les suppression
                    v=v+1;//on update le nombre de supression
                    //DEBUG
                    //console.log("sup = ",sup);
                    //console.log("tableau apres sup = ",myObject[0].features);
                    //console.log("tableau non modif fin = ",myObject[1].features);
                    // console.log("taille du fichier des supp",myObject[0].features.length);   
                    //FIN DEBUG

                    //si la longueur et le type sont identique
                    if (myObject[i].features[j].geometry.coordinates.length === myObject[1].features[numero_de_ligne].geometry.coordinates.length && myObject[i].features[j].geometry.type === myObject[1].features[numero_de_ligne].geometry.type){
                            
                            //attention actuelement il y a deux version de la fonction de comparaison pas completement satisfaisante
                            //Celle utilise est celle qui tient compte de l'ordre dans tous les type
                            //le cas cyclique ne sont pas traité

                            //si au moins une coordonne differente au sens de la fonction de comparaison CompareGeojonGeometry => modif 
                            if (!(CompareGeojsonGeometry( myObject[i].features[j].geometry.coordinates, 
                                                          myObject[1].features[numero_de_ligne].geometry.coordinates,
                                                          myObject[i].features[j].geometry.type))){

                                    myObject[3].push(myObject[i].features[j]);//si les coordonnees sont differente:
                                    // on ajoute cette ligne dans le tableau des modification
                                    //ajout marqueur de modif dans les propriete
                                    myObject[3][myObject[3].length -1].properties[geodiff_type]="mod";
                            }

                    }
                    //sinon c'est une modif (type ou longueur differente )
                    else{
                        myObject[3].push(myObject[i].features[j]);//si les coordonnees sont differente:
                        // on ajoute cette ligne dans le tableau des modification
                        //ajout marqueur de modif dans les propriete 
                        myObject[3][myObject[3].length -1].properties[geodiff_type]="mod";
                    }
                }else {//si l'id ne correspond a aucun du premier fichier
                    //console.log("ajout");
                    myObject[4].push(myObject[i].features[j]);//on la place dand le tableau des ajout
                    //ajout marqueur d'ajout dans les propriete 
                    myObject[4][myObject[4].length -1].properties[geodiff_type]="add"; 
                }  
            }
            //DEBUG
            //console.log("fichier 1:",myObject[1]);
            //console.log("fichier 2:",myObject[2]);
            //console.log("supression",myObject[0].features);
            //console.log("modif",myObject[3]);
            //console.log("ajout",myObject[4]);

            //creation d'une chaine json qui contiendra les features (fich_supp,fich_ajout,fichmodif) et la features collection(fich_total) 
             fich_supp =JSON.stringify(myObject[0].features);
             fich_supp = fich_supp.substring(1,fich_supp.length-1)   //on enleve  les [ ] en trop
             fich_modif =JSON.stringify(myObject[3]);
             fich_modif = fich_modif.substring(1,fich_modif.length-1)//on enleve les [ ] en trop
             fich_ajout =JSON.stringify(myObject[4]);
             fich_ajout = fich_ajout.substring(1,fich_ajout.length-1)//on enleve les [ ] en trop
        
            fich_total='{"type":"FeatureCollection","features":['+fich_modif+","+fich_ajout+","+fich_supp+"]}";
            document.getElementById("download").style.visibility="visible"; //demasquage pour telecharger le resultat zip
            //le zip contiendra 4 fichier 1 avec toutes les differences 3 autre selon le type de differences format geojson


        }
    });
    //chargement des fichier de base 
    fileInput.addEventListener('change', function(){
        reader.readAsText(fileInput.files[0]);   
    }); 
   
</script>
	</body>

</html>



