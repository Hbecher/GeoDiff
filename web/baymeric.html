<!DOCTYPE html>
<html>
    <!-- http://www.commentcamarche.net/forum/affich-26511139-recuperation-de-valeur-d-un-input-html-en-javascript-->
    <!--https://www.europeandataportal.eu/data/en/dataset?country=fr&organization=plateforme-ouverte-des-donnees-publiques-francaises&res_format=GeoJSON-->
    <head>
        <meta charset = "UTF-8"/>
        <title>Geodiff</title>
         <script type="text/javascript" src="jquery-3.1.1.min.js"></script>
         <!--<script type="text/javascript" src="CompareGeojsonGeometry.js"></script>-->
          <script type="text/javascript" src="CompareGeojsonGeometryOrdonne.js"></script>  
    </head> 

    <body>
         <FORM>
            <p>Indiquer le nom de votre champs id svp<p>
            <input type="text" name="id_name_field" id="id_name_field" value="" />
            
            <input type="button" value="OK" onclick="getID();" />

             <input type="button" value="telecharger" onclick="download();" />
        </FORM> 
        <input id="file" type="file" multiple style="visibility: hidden;" />


       <FORM method="POST" action="Transfert.php" id="dataform" hidden>
            <input type="text" name="data" id="datainput" hidden>

      </FORM> 


<script>
    var id_table= new Array();//verif unicite des id 
    id_table[0] = new Array();
    id_table[1] = new Array(); 
    var myObject = new Array();
    myObject[3]=new Array();
    //contiendra les modifications
    myObject[4]=new Array();
    //contiendra les ajouts
    //myObject[0] contiendra les supressions  
    //myObject[1] fichier 1
    //myObject[2] fichier 2
    var i = 1 ;
    var fileInput = document.querySelector('#file');
    //recuperation des fichier d'entree
    var sup;
    //debug voir l'element supprime de myobject[1]
    var v = 0 ;
    //garde le nb de supression 
    var reader = new FileReader();
    var fich_supp="",fich_modif="",fich_ajout="";
    var fich_total="";
    var geodiff_type="geodiff_type" //nom de la propriete a ajouter valeur possible de cette propriete add,del,mod 
    function getID()
    {
        //12:27:05,131 L’utilisation de « getPreventDefault() » est obsolète. Utiliser « defaultPrevented » à la place. geodiff.html
        id_name = document.getElementById("id_name_field").value;
        document.getElementById("file").style.visibility="visible"; //demasquage pour choisir fichier 
        //verifier si un id a bien ete entre 
        console.log("id:",id_name);
        //console.log("id:",id_name);
        //return id_name;
    } 


     function download(){ 
       
            var data =fich_modif +"\n"+ fich_ajout+"\n" +fich_supp+"\n" +fich_total ;//envoyer les 3 fichier avec retour a la ligne ?
            //var data = "4"+"5";
            //var data ="test\ntest\nimportant";
            //var data ='[{"type":"Feature","geometry":{"type":"Point","coordinates":[11,12]},"properties":{"AP_ANTENNE1":"TEST_SUP","Antenne 1":"14 rue Albert 1er de Belgique","longitude":"5.732143","latitude":"45.182819"}}]\ntest\nimportant';
            //console.log(data);
            var form = document.getElementById('dataform');
            var input = document.getElementById('datainput');
            //input.value=urlencode(data);
            input.value=encodeURIComponent(data);
            form.submit();
        }
    

    //evenement fin du chargement du fichier 
    reader.addEventListener('loadend', function(){ 
        //console.log("id:",id_name);
        myObject[i] = (JSON.parse(reader.result));
        var numero_de_ligne = 0;
        //console.log("debut",myObject);
        //console.log(" loadendd i =",i);
        for (var k = 0 ; k < myObject[i].features.length ; k = k + 1 ){//pour chaque element du premier
                if (id_table[i-1][myObject[1].features[k].properties[id_name]] !== undefined){
                    console.log("erreur id non unique");
                }
                else{
                    id_table[i-1][myObject[i].features[k].properties[id_name]] = k;//ajout de l'id et de son indice dans la table
                    //console.log("id_table",i,myObject[i].features[k].properties[id_name],id_table[i-1][myObject[i].features[k].properties[id_name]]);
                }                    

        }
        if (i === 1){//on copie le premier fichier dans myobjet[0] et myobject[1]
            myObject[0] = jQuery.extend(true,{},myObject[1]);//attention
            i = i + 1;
            //ajout marqueur de deletion  dans les propriete a tester 
            for (var l = 0 ; l < myObject[0].features.length ; l = l + 1 ){
                    myObject[0].features[l].properties[geodiff_type]="del";
            }
            /*
            //test copie par val et pas par ref 
            console.log(myObject[0]);
            console.log(myObject[1]);
            myObject[0].features.splice(1,1);
            console.log(myObject[0]);
            console.log(myObject[1]);
             */
        }
        else{
            for (var j = 0 ; j < myObject[i].features.length ; j = j + 1 ){ //parcours du i eme fichier
                if (myObject[i].features[j].properties[id_name] in id_table[0]){
                    //si l' id du feature j du deuxieme fichier existe dans le premier
                    //console.log( "89 ",myObject[i].features[j].properties[id_name]);
                    numero_de_ligne = id_table[0][myObject[i].features[j].properties[id_name]];
                    //console.log(" j ",j,"numero de ligne",numero_de_ligne);
                    //DEBUG
                    //console.log("tableau avant sup = ",myObject[0].features);
                    //console.log("k-v:",k-v);
                    //console.log("v",v);
                    //FIN DEBUG
                    sup = myObject[0].features.splice(numero_de_ligne-v,1);//ce n'est pas une suppression donc on l'enleve du fichier qui contiendra les suppression
                    v=v+1;//on update le nombre de supression
                    //DEBUG
                    //console.log("sup = ",sup);
                    //console.log("tableau apres sup = ",myObject[0].features);
                    //console.log("tableau non modif fin = ",myObject[1].features);
                    // console.log("taille du fichier des supp",myObject[0].features.length);   
                    //FIN DEBUG
                    //to do coordinate dans le cas d'un type autre que point : polygone line ...
                    //to do verif type

                    //si la longueur et le type sont identique
                    if (myObject[i].features[j].geometry.coordinates.length === myObject[1].features[numero_de_ligne].geometry.coordinates.length && myObject[i].features[j].geometry.type === myObject[1].features[numero_de_ligne].geometry.type){

                        //for (var l = 0 ; l < myObject[i].features[j].geometry.coordinates.length ; l++ ){
                            //si au moins une coordonne differente => modif 

                            if (!(CompareGeojsonGeometry( myObject[i].features[j].geometry.coordinates, 
                                                        myObject[1].features[numero_de_ligne].geometry.coordinates,
                                                        myObject[i].features[j].geometry.type))){
                                    console.log("modif 110 : ");

                                    myObject[3].push(myObject[i].features[j]);//si les coordonnees sont differente:
                                    // on ajoute cette ligne dans le tableau des modification
                                    //ajout marqueur de modif dans les propriete a tester 
                                    myObject[3][myObject[3].length -1].properties[geodiff_type]="mod";
                                    

                            }

                        //}

                    }
                    //sinon c'est une modif (type ou longueur differente )
                    else{
                         console.log("modif 122 : ");
                        myObject[3].push(myObject[i].features[j]);//si les coordonnees sont differente:
                        // on ajoute cette ligne dans le tableau des modification
                        //ajout marqueur de modif dans les propriete a tester 
                        myObject[3][myObject[3].length -1].properties[geodiff_type]="mod";
                    }
                }else {//si l'id ne correspond a aucun du premier fichier
                    console.log("ajout");
                    myObject[4].push(myObject[i].features[j]);//on la place dand le tableau des ajout
                    //ajout marqueur d'ajout dans les propriete a tester 
                    myObject[4][myObject[4].length -1].properties[geodiff_type]="add"; 
                }  
            }
            console.log("fichier 1:",myObject[1]);
            console.log("fichier 2:",myObject[2]);
            console.log("supression",myObject[0].features);
            console.log("modif",myObject[3]);
            console.log("ajout",myObject[4]);

            //brouillon en voi serveur 

             fich_supp =JSON.stringify(myObject[0].features);
             fich_supp = fich_supp.substring(1,fich_supp.length-1)
                //console.log("tst",tst);
            //console.log("modif",myObject[3]);
             fich_modif =JSON.stringify(myObject[3]);
             fich_modif = fich_modif.substring(1,fich_modif.length-1)
            //console.log("ajout",myObject[4]);
             fich_ajout =JSON.stringify(myObject[4]);
             fich_ajout = fich_ajout.substring(1,fich_ajout.length-1)
            //console.log("resultat",fich_supp,"\n",fich_modif,"\n",fich_ajout);
            //alert(fich_supp);
            //alert(fich_modif);
            //alert(fich_ajout);
            fich_total='{"type":"FeatureCollection","features":['+fich_modif+","+fich_ajout+","+fich_supp+"]}";
            //le zip contiendra 4 fichier 1 avec toutes les differences 3 autre selon le type de differences format geojson


        }
    });
    fileInput.addEventListener('change', function(){
        reader.readAsText(fileInput.files[0]);   
    }); 
   
</script>
	</body>

</html>



